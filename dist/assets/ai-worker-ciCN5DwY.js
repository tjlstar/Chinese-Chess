(function(){"use strict";const J={K:1e4,R:90,H:40,C:45,E:20,A:20,P:10},h=10,k=9,W=2,q=.5,g=[[9,9,9,11,13,11,9,9,9],[19,24,32,37,37,37,32,24,19],[19,24,32,37,37,37,32,24,19],[19,23,27,29,30,29,27,23,19],[14,18,20,27,29,27,20,18,14],[7,7,7,7,7,7,7,7,7],[5,5,5,5,5,5,5,5,5],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0]],y=[[0,-2,0,2,0,2,0,-2,0],[-2,0,4,2,6,2,4,0,-2],[0,4,2,6,4,6,2,4,0],[2,2,6,8,6,8,6,2,2],[0,6,8,10,8,10,8,6,0],[2,4,6,8,6,8,6,4,2],[0,2,4,6,4,6,4,2,0],[-2,0,2,4,2,4,2,0,-2],[0,-2,0,2,0,2,0,-2,0],[-2,0,0,0,0,0,0,0,-2]],E=[[14,14,14,15,16,15,14,14,14],[14,16,16,17,18,17,16,16,14],[14,16,16,17,18,17,16,16,14],[14,17,17,18,19,18,17,17,14],[14,17,18,19,20,19,18,17,14],[14,16,17,18,19,18,17,16,14],[10,14,14,16,16,16,14,14,10],[8,12,12,14,14,14,12,12,8],[4,8,8,10,10,10,8,8,4],[0,0,4,6,6,6,4,0,0]],K=[[6,7,6,6,5,6,6,7,6],[6,8,7,7,6,7,7,8,6],[7,8,6,8,7,8,6,8,7],[7,9,9,9,7,9,9,9,7],[8,8,7,9,7,9,7,8,8],[8,9,8,10,8,10,8,9,8],[7,8,7,9,9,9,7,8,7],[6,7,6,8,8,8,6,7,6],[5,6,5,7,7,7,5,6,5],[4,4,0,5,4,5,0,4,4]],T=[[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,1,0,1,0,0,0],[0,0,0,0,3,0,0,0,0],[0,0,0,1,0,1,0,0,0]],V=[[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,1,0,0],[0,0,0,0,0,0,0,0,0],[1,0,0,0,3,0,0,0,1],[0,0,0,0,0,0,0,0,0],[0,0,1,0,3,0,1,0,0]],d=[[0,0,0,1,1,1,0,0,0],[0,0,0,1,2,1,0,0,0],[0,0,0,1,2,1,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0],[0,0,0,-2,-3,-2,0,0,0],[0,0,0,-3,-4,-3,0,0,0],[0,0,0,-2,-3,-2,0,0,0]];function I(n,r,e,t,f,i){const s=JSON.parse(JSON.stringify(n));return s[t][f]=i,s[r][e]=null,s}function x(n,r,e){return r<3||r>5?!1:e==="R"?n>=7&&n<=9:e==="B"?n>=0&&n<=2:!1}function D(n,r,e,t,f){if(!x(e,t,f))return!1;const i=Math.abs(n-e),s=Math.abs(r-t);return i===1&&s===0||i===0&&s===1}function G(n,r,e,t,f){return x(e,t,f)?Math.abs(n-e)===1&&Math.abs(r-t)===1:!1}function Q(n,r,e,t,f,i){return!(!(Math.abs(n-e)===2&&Math.abs(r-t)===2)||f==="R"&&e<5||f==="B"&&e>4||i[n+(e-n)/2][r+(t-r)/2])}function U(n,r,e,t,f,i){const s=Math.abs(n-e),c=Math.abs(r-t);if(!(s===1&&c===2||s===2&&c===1))return!1;if(s===2){if(i[n+(e-n)/2][r])return!1}else if(i[n][r+(t-r)/2])return!1;return!0}function X(n,r,e,t,f,i){if(n!==e&&r!==t)return!1;if(n===e){for(let s=Math.min(r,t)+1;s<Math.max(r,t);s++)if(i[n][s])return!1}else for(let s=Math.min(n,e)+1;s<Math.max(n,e);s++)if(i[s][r])return!1;return!0}function Y(n,r,e,t,f,i){if(n!==e&&r!==t)return!1;let s=0;if(n===e)for(let c=Math.min(r,t)+1;c<Math.max(r,t);c++)i[n][c]&&s++;else for(let c=Math.min(n,e)+1;c<Math.max(n,e);c++)i[c][r]&&s++;return i[e][t]?s===1:s===0}function b(n,r,e,t,f){const i=e-n,s=t-r;return f==="R"?n>4?i===-1&&s===0:i===-1&&s===0||i===0&&Math.abs(s)===1:n<5?i===1&&s===0:i===1&&s===0||i===0&&Math.abs(s)===1}function H(n,r){const e=n==="R"?"RK":"BK";for(let t=0;t<h;t++)for(let f=0;f<k;f++)if(r[t][f]&&r[t][f].substring(0,2)===e)return{r:t,c:f};return null}function O(n,r){let e=0;for(let t=0;t<h;t++)for(let f=0;f<k;f++){const i=n[t][f];if(i&&i.charAt(0)===r)for(let s=0;s<h;s++)for(let c=0;c<k;c++)m(t,f,s,c,i,n)&&e++}return e}function j(n){let r=0,e=0,t=0,f=0;for(let l=0;l<h;l++)for(let a=0;a<k;a++){const v=n[l][a];if(!v)continue;const A=v.charAt(0),R=v.charAt(1);let C=J[R]||0,M=0;if(A==="R"){switch(e+=C,R){case"P":M=g[l][a];break;case"H":M=y[l][a];break;case"R":M=E[l][a];break;case"C":M=K[l][a];break;case"A":M=T[l][a];break;case"E":M=V[l][a];break;case"K":M=d[l][a];break}f+=M}else{r+=C;const B=9-l,_=8-a;switch(R){case"P":M=g[B][_];break;case"H":M=y[B][_];break;case"R":M=E[B][_];break;case"C":M=K[B][_];break;case"A":M=T[B][_];break;case"E":M=V[B][_];break;case"K":M=d[B][_];break}t+=M}}const i=r+t,s=e+f,c=O(n,"B"),u=O(n,"R"),o=(c-u)*q;return i-s+o}function L(n,r,e,t,f,i){if(n<0||n>=h||r<0||r>=k||e<0||e>=h||t<0||t>=k)return!1;const s=f.charAt(1),c=f.charAt(0),u=i[e][t];if(u&&u.charAt(0)===c||n===e&&r===t)return!1;switch(s){case"K":return D(n,r,e,t,c);case"A":return G(n,r,e,t,c);case"E":return Q(n,r,e,t,c,i);case"H":return U(n,r,e,t,c,i);case"R":return X(n,r,e,t,c,i);case"C":return Y(n,r,e,t,c,i);case"P":return b(n,r,e,t,c);default:return!1}}function F(n,r){const e=H(n,r);if(!e)return!0;const t=n==="R"?"B":"R";for(let i=0;i<h;i++)for(let s=0;s<k;s++){const c=r[i][s];if(c&&c.charAt(0)===t&&L(i,s,e.r,e.c,c,r)&&c.substring(1,2)!=="K")return!0}const f=H(t,r);if(f&&e.c===f.c){let i=!1;for(let s=Math.min(e.r,f.r)+1;s<Math.max(e.r,f.r);s++)if(r[s][e.c]){i=!0;break}if(!i)return!0}return!1}function m(n,r,e,t,f,i){if(!L(n,r,e,t,f,i))return!1;const s=f.charAt(0),c=I(i,n,r,e,t,f);return!F(s,c)}function N(n,r){const e=[],t=r==="R"?"B":"R";for(let f=0;f<h;f++)for(let i=0;i<k;i++){const s=n[f][i];if(s&&s.charAt(0)===r)for(let c=0;c<h;c++)for(let u=0;u<k;u++){const o=n[c][u];o&&o.charAt(0)===t&&m(f,i,c,u,s,n)&&e.push({fromRow:f,fromCol:i,toRow:c,toCol:u,pieceId:s})}}return e}function P(n,r,e,t,f){const i=j(n);if(f===0)return i;const s=t?"B":"R";if(t){if(i>=e)return i;r=Math.max(r,i);let c=i;const u=N(n,s);if(u.length===0)return i;for(const o of u){const l=I(n,o.fromRow,o.fromCol,o.toRow,o.toCol,o.pieceId),a=P(l,r,e,!1,f-1);if(c=Math.max(c,a),r=Math.max(r,c),e<=r)break}return c}else{if(i<=r)return i;e=Math.min(e,i);let c=i;const u=N(n,s);if(u.length===0)return i;for(const o of u){const l=I(n,o.fromRow,o.fromCol,o.toRow,o.toCol,o.pieceId),a=P(l,r,e,!0,f-1);if(c=Math.min(c,a),e=Math.min(e,c),e<=r)break}return c}}function p(n,r,e,t,f){if(r===0)return P(n,e,t,f,W);const i=f?"B":"R";if(f){let s=-1/0;for(let c=0;c<h;c++){for(let u=0;u<k;u++){const o=n[c][u];if(o&&o.charAt(0)===i)for(let l=0;l<h;l++){for(let a=0;a<k;a++)if(m(c,u,l,a,o,n)){const v=I(n,c,u,l,a,o),A=p(v,r-1,e,t,!1);if(s=Math.max(s,A),e=Math.max(e,A),t<=e)break}if(t<=e)break}if(t<=e)break}if(t<=e)break}return s}else{let s=1/0;for(let c=0;c<h;c++){for(let u=0;u<k;u++){const o=n[c][u];if(o&&o.charAt(0)===i)for(let l=0;l<h;l++){for(let a=0;a<k;a++)if(m(c,u,l,a,o,n)){const v=I(n,c,u,l,a,o),A=p(v,r-1,e,t,!0);if(s=Math.min(s,A),t=Math.min(t,A),t<=e)break}if(t<=e)break}if(t<=e)break}if(t<=e)break}return s}}function Z(n,r=3){let e=null,t=-1/0,f=-1/0,i=1/0;for(let s=0;s<h;s++)for(let c=0;c<k;c++){const u=n[s][c];if(u&&u.charAt(0)==="B"){for(let o=0;o<h;o++)for(let l=0;l<k;l++)if(m(s,c,o,l,u,n)){const a=I(n,s,c,o,l,u),v=p(a,r-1,f,i,!1);v>t&&(t=v,e={fromRow:s,fromCol:c,toRow:o,toCol:l,pieceId:u}),f=Math.max(f,t)}}}return e}self.onmessage=function(n){const{type:r,boardState:e,depth:t}=n.data;if(r==="findBestMove"){const f=Z(e,t);self.postMessage({type:"bestMove",move:f})}}})();
